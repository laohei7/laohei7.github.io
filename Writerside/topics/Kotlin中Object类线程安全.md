# Kotlinä¸­Objectç±»çº¿ç¨‹å®‰å…¨


## **Kotlin `object` çš„çº¿ç¨‹å®‰å…¨æ€§è¯¦è§£**

åœ¨ Kotlin ä¸­ï¼Œ`object` å…³é”®å­—ç”¨äºå£°æ˜**å•ä¾‹ï¼ˆSingletonï¼‰**å¯¹è±¡ã€‚å®ƒæä¾›äº†ä¸€ç§**æ‡’åŠ è½½ã€å…¨å±€å”¯ä¸€**çš„æ–¹å¼æ¥ç®¡ç†å…±äº«èµ„æºã€‚ç„¶è€Œï¼Œ
**å•ä¾‹ â‰  çº¿ç¨‹å®‰å…¨**ï¼Œå¦‚æœ `object` å†…éƒ¨æœ‰å¯å˜çŠ¶æ€ï¼ˆMutable Stateï¼‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä»ç„¶å¯èƒ½å‡ºç°ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰ã€‚

---

## **1. `object` æ˜¯å¦‚ä½•ä¿è¯å•ä¾‹çš„ï¼Ÿ**

Kotlin `object` åœ¨ **ç±»åŠ è½½ï¼ˆClass Loadingï¼‰é˜¶æ®µ** é‡‡ç”¨äº† **JVM çš„ `static` ä»£ç å—** è¿›è¡Œåˆå§‹åŒ–ï¼š

```kotlin
object Singleton {
    val instance: Singleton = Singleton()
}
```

åº•å±‚ç­‰ä»·äº Javaï¼š

```java
public final class Singleton {
    public static final Singleton INSTANCE;

    static {
        INSTANCE = new Singleton();
    }

    private Singleton() {
    }
}
```

### **å•ä¾‹çš„çº¿ç¨‹å®‰å…¨æ€§**

1. **JVM ä¿è¯ `object` çš„åˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„**
    - `object` çš„åˆå§‹åŒ–è¿‡ç¨‹ä½¿ç”¨äº† **ç±»åŠ è½½æœºåˆ¶ï¼ˆClass Loadingï¼‰**ï¼ŒJVM è§„å®šç±»çš„åˆå§‹åŒ–**æœ€å¤šåªèƒ½æ‰§è¡Œä¸€æ¬¡**ï¼Œé¿å…äº†å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ›å»ºå®ä¾‹çš„é—®é¢˜ã€‚
    - å› æ­¤ï¼Œ**åœ¨ `object` åˆ›å»ºé˜¶æ®µæ˜¯çº¿ç¨‹å®‰å…¨çš„**ï¼Œä¸ä¼šæœ‰å¤šä¸ªå®ä¾‹ã€‚

---

## **2. ä¸ºä»€ä¹ˆ `object` ä¸æ˜¯å®Œå…¨çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ**

å°½ç®¡ `object` **çš„åˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„**ï¼Œä½†å¦‚æœ `object` å†…éƒ¨åŒ…å« **å¯å˜çŠ¶æ€ï¼ˆMutable Stateï¼‰**ï¼Œåˆ™å¤šçº¿ç¨‹è®¿é—®æ—¶ä¼šå‡ºç° *
*ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰**ã€‚

### **ç¤ºä¾‹ï¼šéçº¿ç¨‹å®‰å…¨çš„ `object`**

```kotlin
object Counter {
    var count = 0

    fun increment() {
        count++
    }
}
```

### **å¯èƒ½å‡ºç°çš„é—®é¢˜**

å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ `increment()`ï¼š

```
Thread A: è¯»å– count = 0
Thread B: è¯»å– count = 0
Thread A: è®¡ç®— count = 1
Thread B: è®¡ç®— count = 1
Thread A: å­˜å‚¨ count = 1
Thread B: å­˜å‚¨ count = 1
```

æœ€ç»ˆ `count = 1`ï¼Œä½†**ç†åº”æ˜¯ `2`ï¼** è¿™ä¸ªé—®é¢˜è¢«ç§°ä¸º **ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰**ã€‚

---

## **3. å¦‚ä½•ä¿è¯ `object` å†…éƒ¨çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ**

### **æ–¹æ³• 1ï¼šä½¿ç”¨ `synchronized`**

`synchronized` å…³é”®å­—å¯ä»¥ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…³é”®ä»£ç ï¼š

```kotlin
object Counter {
    var count = 0

    @Synchronized
    fun increment() {
        count++
    }
}
```

**ä¼˜ç‚¹**ï¼š
âœ… **ç®€å•ç›´æ¥**ï¼Œé€‚ç”¨äº Java ä¼ ç»ŸåŒæ­¥æ–¹æ³•ã€‚  
**ç¼ºç‚¹**ï¼š
âŒ **ä¼šé˜»å¡çº¿ç¨‹**ï¼Œé™ä½æ€§èƒ½ã€‚

---

### **æ–¹æ³• 2ï¼šä½¿ç”¨ `Mutex`ï¼ˆæ¨èï¼Œé€‚ç”¨äºåç¨‹ï¼‰**

åœ¨ `Kotlin Coroutine` ä¸­ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ `Mutex`ï¼Œå› ä¸ºå®ƒä¸ä¼šé˜»å¡çº¿ç¨‹ï¼š

```kotlin
object Counter {
   private val mutex = Mutex()
   var count = 0

   suspend fun increment() {
      mutex.withLock {
         count++
      }
   }
}
```

**ä¼˜ç‚¹**ï¼š
âœ… **ä¸ä¼šé˜»å¡çº¿ç¨‹**ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ã€‚  
âœ… **æ”¯æŒåç¨‹æŒ‚èµ·å‡½æ•°ï¼ˆsuspendï¼‰**ã€‚  
**ç¼ºç‚¹**ï¼š
âŒ **åªèƒ½ç”¨äº `suspend` å‡½æ•°**ï¼ŒåŒæ­¥ä»£ç æ— æ³•ä½¿ç”¨ã€‚

---

### **æ–¹æ³• 3ï¼šä½¿ç”¨ `Atomic` å˜é‡ï¼ˆé€‚ç”¨äºç®€å•æ•°å€¼æ“ä½œï¼‰**

å¦‚æœ `object` åªç»´æŠ¤ä¸€ä¸ªç®€å•çš„æ•°å€¼å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ `AtomicInteger`ï¼š

```kotlin
object Counter {
    private val count = AtomicInteger(0)

    fun increment() {
        count.incrementAndGet()
    }

    fun getCount(): Int = count.get()
}
```

**ä¼˜ç‚¹**ï¼š
âœ… **é«˜æ•ˆï¼Œæ— é”æ“ä½œï¼ˆLock-freeï¼‰**ã€‚  
âœ… **é€‚ç”¨äº `Int/Long` è®¡æ•°ç­‰ç®€å•åœºæ™¯**ã€‚  
**ç¼ºç‚¹**ï¼š
âŒ **ä¸é€‚ç”¨äºå¤æ‚å¯¹è±¡**ï¼Œå¦‚ `List`ã€`Map`ã€‚

---

### **æ–¹æ³• 4ï¼šä½¿ç”¨ `StateFlow`ï¼ˆé€‚ç”¨äº Compose å’Œåç¨‹ç¯å¢ƒï¼‰**

`StateFlow` é€‚ç”¨äº UI ç»‘å®šåœºæ™¯ï¼š

```kotlin
object Counter {
    private val _count = MutableStateFlow(0)
    val count = _count.asStateFlow()

    suspend fun increment() {
        _count.value = _count.value + 1
    }
}
```

**ä¼˜ç‚¹**ï¼š
âœ… **é€‚ç”¨äº Jetpack Composeï¼Œå¯å®æ—¶æ›´æ–° UI**ã€‚  
âœ… **ä¸ `Flow` ç»“åˆï¼Œå¯ç›‘å¬çŠ¶æ€å˜åŒ–**ã€‚  
**ç¼ºç‚¹**ï¼š
âŒ **éœ€è¦ä½¿ç”¨åç¨‹**ã€‚

---

## **4. ç»“è®º**

| **æ–¹æ³•**              | **çº¿ç¨‹å®‰å…¨**              | **é€‚ç”¨åœºæ™¯**        | **ä¼˜ç¼ºç‚¹**                       |
|---------------------|-----------------------|-----------------|-------------------------------|
| **`object` å•ä¾‹**     | âœ…ï¼ˆåˆå§‹åŒ–å®‰å…¨ï¼‰ / âŒï¼ˆå¯å˜æ•°æ®ä¸å®‰å…¨ï¼‰ | ä»…ç”¨äºå…¨å±€å®ä¾‹         | **é€‚ç”¨äºæ— å¯å˜æ•°æ®çš„æƒ…å†µ**               |
| **`synchronized`**  | âœ…                     | ä¼ ç»ŸåŒæ­¥ä»£ç           | **é€‚åˆ Java ä»£ç ï¼Œå¯èƒ½é˜»å¡çº¿ç¨‹**         |
| **`Mutex`**         | âœ…                     | **æ¨èï¼Œé€‚ç”¨äºåç¨‹ç¯å¢ƒ**  | **ä¸ä¼šé˜»å¡çº¿ç¨‹**ï¼Œä½†åªèƒ½åœ¨ `suspend` ä¸­ä½¿ç”¨ |
| **`AtomicInteger`** | âœ…                     | è®¡æ•°ã€ç®€å•æ•°å€¼æ“ä½œ       | **æ— é”ï¼Œé€‚åˆç®€å•æ•°æ®**                 |
| **`StateFlow`**     | âœ…                     | Jetpack Compose | **é€‚ç”¨äº UI ç»‘å®šçŠ¶æ€**               |

---

## **æœ€ç»ˆå»ºè®®**

- **åªè¯»å¯¹è±¡ï¼ˆImmutableï¼‰** âœ… ç›´æ¥ä½¿ç”¨ `object`ï¼Œæ— éœ€é¢å¤–åŒæ­¥ã€‚
- **ä¿®æ”¹å…±äº«æ•°æ®ï¼ˆMutable Stateï¼‰** âœ… æ¨è **`Mutex` + `StateFlow`**ã€‚
- **ä»…è®¡æ•°æˆ–ç®€å•æ•°å€¼æ“ä½œ** âœ… ä½¿ç”¨ `AtomicInteger`ã€‚
- **ä¼ ç»ŸåŒæ­¥æ–¹æ³•** âœ… ä½¿ç”¨ `synchronized`ï¼ˆä½†æ€§èƒ½è¾ƒå·®ï¼‰ã€‚

âœ… **æ¨èæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰**

```kotlin
object SafeCounter {
    private val mutex = Mutex()
    private val _count = MutableStateFlow(0)
    val count = _count.asStateFlow()

    suspend fun increment() {
        mutex.withLock {
            _count.value++
        }
    }
}
```

- **çº¿ç¨‹å®‰å…¨**
- **ä¸ä¼šé˜»å¡**
- **æ”¯æŒ Compose & Flow ç›‘å¬**

è¿™æ ·å¯ä»¥ç¡®ä¿ `object` **æ—¢èƒ½ä¿è¯å•ä¾‹ï¼Œåˆèƒ½å®‰å…¨åœ°å¤„ç†å¹¶å‘è®¿é—®ï¼** ğŸš€